<html dir="ltr"><head>
        <title>EARTH3D EXAMPLE</title>
        <meta charset="UTF-8"> 
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="vendor/three.js" type="text/javascript"></script>
        <script src="vendor/Detector.js" type="text/javascript"></script>
        <script src="vendor/Projector.js" type="text/javascript"></script>
        <script src="vendor/TrackballControls.js" type="text/javascript"></script>
        <script src="vendor/tween.min.js" type="text/javascript"></script>
        <script src="vendor/stats.min.js" type="text/javascript"></script>
        <script src="../lib/earth3d.js" type="text/javascript"></script>
    </head>
    <body contenteditable="true">
        <script>
            //var element = document.getElementById("ThreeJS");
            var element=document.body;
            function retrieveData() {
                xhr = new XMLHttpRequest();
                xhr.open('GET', 'data/ip.json', true);
                xhr.onreadystatechange = function (e) {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            var rawdata = JSON.parse(xhr.responseText);
                            var data = rawdata;
                            spr.init(data);
                            animate();
                        }
                    } else {
                    }
                };
                xhr.send(null);
            }

            function animate() {
                requestAnimationFrame(animate);
                spr.render();
                spr.update();
            }

            function onWindowResize(event) {
                spr.onWindowResize(event);
            }

            function onMouseMove(event) {
                spr.onMouseMove(event);
            }

            function makeTextSprite(message, parameters)
            {
                var fontface = null, fontsize = null, borderThickness = null,
                        borderColor = null, backgroundColor = null, vpadding = null,
                        hpadding = null, rectWidth = 0, rectHeight = 0,
                        canvas = null, context = null,
                        i = 0, sz = 0, s = "";
                if (parameters === undefined)
                    parameters = {};

                fontface = parameters.hasOwnProperty("fontface") ?
                        parameters["fontface"] : "Arial";

                fontsize = parameters.hasOwnProperty("fontsize") ?
                        parameters["fontsize"] : 18;

                borderThickness = parameters.hasOwnProperty("borderThickness") ?
                        parameters["borderThickness"] : 4;

                borderColor = parameters.hasOwnProperty("borderColor") ?
                        parameters["borderColor"] : {r: 0, g: 0, b: 0, a: 1.0};

                backgroundColor = parameters.hasOwnProperty("backgroundColor") ?
                        parameters["backgroundColor"] : {r: 255, g: 255, b: 255, a: 1.0};
                vpadding = parameters.hasOwnProperty("vpadding") ?
                        parameters["vpadding"] : 4;
                hpadding = parameters.hasOwnProperty("hpadding") ?
                        parameters["hpadding"] : 4;

                canvas = document.createElement('canvas');
                canvas.id = "canvasInfo_" + Math.random();
                context = canvas.getContext('2d');
                context.font = "Bold " + fontsize + "px " + fontface;


                // get size data (height depends only on font size)
                // Calculate rect dimension. Width=MAX message[i].widt ; Heigh=numLines*fontsize;
                for (i = 0, sz = message.length; i < sz; i++) {
                    s = message[i], metrics = context.measureText(s), textWidth = metrics.width, textHeigh = null;
                    if (textWidth > rectWidth) {
                        rectWidth = textWidth;
                    }
                    textHeigh = fontsize;
                    rectHeight = rectHeight + textHeigh;
                }
                rectHeight = (rectHeight * 1.4) + vpadding * 2;
                rectWidth = rectWidth + hpadding * 2;
                // background color
                context.fillStyle = "rgba(" + backgroundColor.r + "," + backgroundColor.g + ","
                        + backgroundColor.b + "," + backgroundColor.a + ")";
                // border color
                context.strokeStyle = "rgba(" + borderColor.r + "," + borderColor.g + ","
                        + borderColor.b + "," + borderColor.a + ")";


                roundRect(context, borderThickness / 2, borderThickness / 2, rectWidth + borderThickness, rectHeight + borderThickness, 6, borderThickness);
                // 1.4 is extra height factor for text below baseline: g,j,p,q.

                // text color
                context.fillStyle = "rgba(0, 0, 0, 1.0)";
                for (i = 0, sz = message.length; i < sz; i++) {
                    s = message[i];
                    context.fillText(s, borderThickness + hpadding, (fontsize * 1.4 * i) + fontsize + borderThickness + vpadding);
                }
                return canvas;
            }

            // function for drawing rounded rectangles
            function roundRect(ctx, x, y, w, h, r, border)
            {
                var oldlineWidth = ctx.lineWidth;
                ctx.lineWidth = border;
                ctx.beginPath();
                ctx.moveTo(x + r, y);
                ctx.lineTo(x + w - r, y);
                ctx.quadraticCurveTo(x + w, y, x + w, y + r);
                ctx.lineTo(x + w, y + h - r);
                ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
                ctx.lineTo(x + r, y + h);
                ctx.quadraticCurveTo(x, y + h, x, y + h - r);
                ctx.lineTo(x, y + r);
                ctx.quadraticCurveTo(x, y, x + r, y);
                ctx.closePath();
                ctx.fill();
                if (border > 0) {
                    ctx.stroke();
                }
                ctx.lineWidth = oldlineWidth;
            }
            
            //GEOGLOBE
            var spr = new GeoPosition({
                domElement: element,
                showStats: true,
                texture:'resources/world_black.jpg',
                onSelectBox: function (item) {
                    var canvas = makeTextSprite([
                        'IP: ' + item.ip,
                        'Num Access: ' + item.accesos,
                        'Country: ' + item.country,
                        'City: ' + item.city
                    ],{         fontsize: 12,
                                borderThickness: 0,
                                borderColor: {r: 0, g: 100, b: 160, a: 1},
                                backgroundColor: {r: 151, g: 182, b: 204, a: 0.7}
                            });
                    return canvas;
                }
            }); 

            //STARTING POINT
            retrieveData();
//            window.addEventListener('resize', onWindowResize, false);
//            window.addEventListener('mousemove', onMouseMove, false);
            element.addEventListener('resize', onWindowResize, false);
            element.addEventListener('mousemove', onMouseMove, false);
        </script>
    </body></html>